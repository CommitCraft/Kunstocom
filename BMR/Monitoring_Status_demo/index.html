<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Time Slot Data Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js"></script>
  </head>
  <body class="bg-gray-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto bg-white shadow-lg rounded-xl p-6">
      <h1 class="text-2xl font-bold mb-4">Time Slot Data Management</h1>

      <!-- Search + Export Controls -->
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
        <!-- Search -->
        <input
          id="searchInput"
          type="text"
          placeholder="Search in table..."
          class="border rounded-lg p-2 w-full md:w-1/3"
          onkeyup="searchTable()"
        />

        <!-- Date Range + Export -->
        <div class="flex items-center gap-2">
          <input type="date" id="fromDate" class="border rounded-lg p-2" />
          <span class="font-semibold">to</span>
          <input type="date" id="toDate" class="border rounded-lg p-2" />
          <button
            onclick="exportToExcel()"
            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded"
          >
            Export Excel
          </button>
        </div>
      </div>

      <!-- Table -->
      <div class="overflow-x-auto">
        <table
          class="min-w-full border border-gray-300 rounded-lg overflow-hidden"
        >
          <thead class="bg-gray-200">
            <tr>
              <th class="border p-2">Date</th>
              <th class="border p-2">Section</th>
              <th class="border p-2">Check Point</th>
              <th class="border p-2">Mold</th>
              <th class="border p-2">Spec / Method</th>
              <th class="border p-2">Measuring Tool</th>
              <th class="border p-2">Time Range</th>
              <th class="border p-2">Measured Value</th>
              <th class="border p-2">Result</th>
              <th class="border p-2">Remarks</th>
              <th class="border p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="dataTable">
            <!-- Dynamic rows go here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Your Edit Modal here (unchanged) -->
    <!-- ... -->

    <script>
      const API_URL = "http://localhost:1880/time-check-all-report"; // Node-RED API
      let allData = []; // keep full dataset for filtering/export

      window.onload = loadAllData;

      async function loadAllData() {
        try {
          const res = await fetch(API_URL);
          if (res.ok) {
            let data = await res.json();
            data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            allData = data; // store globally
            renderTable(data);
          }
        } catch (err) {
          console.error("Error fetching data:", err);
        }
      }

      function formatDate(dateString) {
        if (!dateString) return "";
        const d = new Date(dateString);
        return d.toISOString().split("T")[0]; // YYYY-MM-DD
      }

      function renderTable(data) {
        const tbody = document.getElementById("dataTable");
        tbody.innerHTML = "";

        data.forEach((item) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="border p-2">${formatDate(item.created_at)}</td>
            <td class="border p-2">${item.section || ""}</td>
            <td class="border p-2">${item.checkpoint || ""}</td>
            <td class="border p-2">${item.mold || ""}</td>
            <td class="border p-2">${item.spec || ""}</td>
            <td class="border p-2">${item.tool || ""}</td>
            <td class="border p-2">${item.time_range || ""}</td>
            <td class="border p-2">${item.measured_value || ""}</td>
            <td class="border p-2">${item.result || ""}</td>
            <td class="border p-2">${item.remarks || ""}</td>
            <td class="border p-2 text-center flex gap-2 justify-center">
              <button onclick='openEditModal(${JSON.stringify(
                item
              )})' class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">Edit</button>
              <button onclick='deleteRow(${
                item.id
              })' class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      function searchTable() {
        const filter = document.getElementById("searchInput").value.toLowerCase();
        const rows = document.querySelectorAll("#dataTable tr");
        rows.forEach((row) => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(filter) ? "" : "none";
        });
      }

      // --- EXPORT TO EXCEL ---
      function exportToExcel() {
        const fromDate = document.getElementById("fromDate").value;
        const toDate = document.getElementById("toDate").value;

        let filtered = allData;
        if (fromDate && toDate) {
          filtered = allData.filter((item) => {
            const d = formatDate(item.created_at);
            return d >= fromDate && d <= toDate;
          });
        }

        if (filtered.length === 0) {
          alert("No data available for the selected date range.");
          return;
        }

        // convert to sheet format
        const exportData = filtered.map((item) => ({
          Date: formatDate(item.created_at),
          Section: item.section || "",
          "Check Point": item.checkpoint || "",
          Mold: item.mold || "",
          "Spec / Method": item.spec || "",
          "Measuring Tool": item.tool || "",
          "Time Range": item.time_range || "",
          "Measured Value": item.measured_value || "",
          Result: item.result || "",
          Remarks: item.remarks || "",
        }));

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "TimeSlots");
        XLSX.writeFile(wb, "TimeSlot_Report.xlsx");
      }
    </script>
  </body>
</html>
