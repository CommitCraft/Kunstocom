<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Time Check Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <!-- Toast Notification (hidden initially) -->
  <div id="toast" class="fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-500 translate-y-[-50px] opacity-0 z-50">
    <!-- Message will be injected here -->
  </div>

  <div class="max-w-5xl mx-auto bg-white p-6 rounded-2xl shadow-lg">
    <h1 class="text-2xl font-bold mb-4 text-center">Time Check Inspection Report</h1>

    <!-- Top selection form -->
    <form id="reportForm" class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
      <div>
        <label class="block text-sm font-medium mb-1">Section</label>
        <select class="w-full border rounded-lg p-2" id="section">
          <option value="">Select Section</option>
          <option>Section A</option>
          <option>Section B</option>
          <option>Section C</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Check Point</label>
        <select class="w-full border rounded-lg p-2" id="checkpoint">
          <option value="">Select Check Point</option>
          <option>CP1</option>
          <option>CP2</option>
          <option>CP3</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Mold</label>
        <select class="w-full border rounded-lg p-2" id="mold">
          <option value="">Select Mold</option>
          <option>Mold 1</option>
          <option>Mold 2</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Spec / Method</label>
        <select class="w-full border rounded-lg p-2" id="spec">
          <option value="">Select Spec</option>
          <option>Spec A</option>
          <option>Spec B</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium mb-1">Measuring Tool</label>
        <select class="w-full border rounded-lg p-2" id="tool">
          <option value="">Select Tool</option>
          <option>Caliper</option>
          <option>Micrometer</option>
        </select>
      </div>
    </form>

    <!-- Time check table -->
    <div class="overflow-x-auto">
      <table class="min-w-full border border-gray-300 rounded-lg">
        <thead class="bg-gray-200">
          <tr>
            <th class="border p-2 text-left">Time</th>
            <th class="border p-2 text-left">Measured Value</th>
            <th class="border p-2 text-left">Result (OK/NG)</th>
            <th class="border p-2 text-left">Remarks</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="border p-2">8:00 AM - 10:00 AM</td>
            <td class="border p-2"><input type="text" class="w-full border rounded-lg p-1"></td>
            <td class="border p-2">
              <select class="w-full border rounded-lg p-1">
                <option>OK</option>
                <option>NG</option>
              </select>
            </td>
            <td class="border p-2"><input type="text" class="w-full border rounded-lg p-1"></td>
          </tr>
          <tr>
            <td class="border p-2">10:00 AM - 12:00 PM</td>
            <td class="border p-2"><input type="text" class="w-full border rounded-lg p-1"></td>
            <td class="border p-2">
              <select class="w-full border rounded-lg p-1">
                <option>OK</option>
                <option>NG</option>
              </select>
            </td>
            <td class="border p-2"><input type="text" class="w-full border rounded-lg p-1"></td>
          </tr>
          <tr>
            <td class="border p-2">12:00 PM - 2:00 PM</td>
            <td class="border p-2"><input type="text" class="w-full border rounded-lg p-1"></td>
            <td class="border p-2">
              <select class="w-full border rounded-lg p-1">
                <option>OK</option>
                <option>NG</option>
              </select>
            </td>
            <td class="border p-2"><input type="text" class="w-full border rounded-lg p-1"></td>
          </tr>
          <tr>
            <td class="border p-2">2:00 PM - 4:00 PM</td>
            <td class="border p-2"><input type="text" class="w-full border rounded-lg p-1"></td>
            <td class="border p-2">
              <select class="w-full border rounded-lg p-1">
                <option>OK</option>
                <option>NG</option>
              </select>
            </td>
            <td class="border p-2"><input type="text" class="w-full border rounded-lg p-1"></td>
          </tr>
          <tr>
            <td class="border p-2">4:00 PM - 6:00 PM</td>
            <td class="border p-2"><input type="text" class="w-full border rounded-lg p-1"></td>
            <td class="border p-2">
              <select class="w-full border rounded-lg p-1">
                <option>OK</option>
                <option>NG</option>
              </select>
            </td>
            <td class="border p-2"><input type="text" class="w-full border rounded-lg p-1"></td>
          </tr>
          <tr>
            <td class="border p-2">6:00 PM - 8:00 PM</td>
            <td class="border p-2"><input type="text" class="w-full border rounded-lg p-1"></td>
            <td class="border p-2">
              <select class="w-full border rounded-lg p-1">
                <option>OK</option>
                <option>NG</option>
              </select>
            </td>
            <td class="border p-2"><input type="text" class="w-full border rounded-lg p-1"></td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Submit button -->
    <div class="text-center mt-6">
      <button id="submitBtn" type="button" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
        Submit Report
      </button>
    </div>
  </div>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const API_URL = "http://localhost:1880/time-check-report"; // Node-RED endpoint

  const timeRanges = [
    { label: "8:00 AM - 10:00 AM", start: 8, end: 10 },
    { label: "10:00 AM - 12:00 PM", start: 10, end: 12 },
    { label: "12:00 PM - 2:00 PM", start: 12, end: 14 },
    { label: "2:00 PM - 4:00 PM", start: 14, end: 16 },
    { label: "4:00 PM - 6:00 PM", start: 16, end: 18 },
    { label: "6:00 PM - 8:00 PM", start: 18, end: 20 }
  ];

  function getCurrentTimeRangeIndex() {
    const now = new Date();
    const hours = now.getHours();
    return timeRanges.findIndex(range => hours >= range.start && hours < range.end);
  }

  function updateTimeSlots() {
    const currentIndex = getCurrentTimeRangeIndex();
    const rows = document.querySelectorAll("tbody tr");

    rows.forEach((row, index) => {
      const inputs = row.querySelectorAll("input, select");

      if (index === currentIndex) {
        inputs.forEach(input => input.disabled = false);
        row.classList.add("bg-green-100");
        row.classList.remove("bg-gray-100");
        row.dataset.active = "true";
      } else {
        inputs.forEach(input => input.disabled = true);
        row.classList.add("bg-gray-100");
        row.classList.remove("bg-green-100");
        row.dataset.active = "false";
      }
    });
  }

  function showToast(message, type) {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.className = `fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-500 z-50
      ${type === "success" ? "bg-green-500" : "bg-red-500"}`;
    toast.classList.remove("opacity-0", "-translate-y-5");
    toast.classList.add("opacity-100", "translate-y-0");

    setTimeout(() => {
      toast.classList.remove("opacity-100", "translate-y-0");
      toast.classList.add("opacity-0", "-translate-y-5");
    }, 3000);
  }

  function normalizeTime(str) {
  return str
    .toLowerCase()
    .replace(/\s+/g, " ")       // multiple spaces â†’ single space
    .replace(/am/g, "am")       // normalize am
    .replace(/pm/g, "pm")       // normalize pm
    .replace(/^0+/g, "")        // remove leading zeros from start
    .trim();
}

async function loadCurrentTimeSlotData() {
  const section = document.getElementById("section").value;
  const checkpoint = document.getElementById("checkpoint").value;
  const mold = document.getElementById("mold").value;
  const spec = document.getElementById("spec").value;
  const tool = document.getElementById("tool").value;

  try {
    const res = await fetch(`${API_URL}?section=${encodeURIComponent(section)}&checkpoint=${encodeURIComponent(checkpoint)}&mold=${encodeURIComponent(mold)}&spec=${encodeURIComponent(spec)}&tool=${encodeURIComponent(tool)}`);
    if (res.ok) {
      const data = await res.json();

      data.forEach(item => {
        const rows = document.querySelectorAll("tbody tr");
        rows.forEach(row => {
          const timeCell = row.querySelector("td").textContent.trim();

          if (normalizeTime(timeCell) === normalizeTime(item.time_range)) {
            row.querySelectorAll("input")[0].value = item.measured_value || "";
            row.querySelector("select").value = item.result || "OK";
            row.querySelectorAll("input")[1].value = item.remarks || "";
          }
        });
      });
    }
  } catch (err) {
    console.error("Error fetching data:", err);
  }
}

 
  document.getElementById("submitBtn").addEventListener("click", async () => {
    const section = document.getElementById("section").value;
    const checkpoint = document.getElementById("checkpoint").value;
    const mold = document.getElementById("mold").value;
    const spec = document.getElementById("spec").value;
    const tool = document.getElementById("tool").value;

    if (!section || !checkpoint) {
      showToast("Please fill all required fields!", "error");
      return;
    }

    const activeRow = document.querySelector("tbody tr[data-active='true']");
    if (!activeRow) {
      showToast("No active time slot available to submit!", "error");
      return;
    }

    const currentIndex = getCurrentTimeRangeIndex();
    const measuredValue = activeRow.querySelectorAll("input")[0].value;
    const result = activeRow.querySelector("select").value;
    const remarks = activeRow.querySelectorAll("input")[1].value;

    const reportData = {
      section,
      checkpoint,
      mold,
      spec,
      tool,
      time_range: timeRanges[currentIndex].label,
      measured_value: measuredValue,
      result,
      remarks
    };

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(reportData)
      });

      if (res.ok) {
        showToast("Report submitted successfully!", "success");
      } else {
        showToast("Failed to submit report!", "error");
      }
    } catch (error) {
      console.error(error);
      showToast("Error connecting to server!", "error");
    }
  });

  // On load
  updateTimeSlots();
  loadCurrentTimeSlotData();

  // Update every minute
  setInterval(() => {
    updateTimeSlots();
    loadCurrentTimeSlotData();
  }, 60 * 1000);
});
</script>
</body>
</html>
